<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <title>Save My Invite</title>
</head>
<body>
<br />

<div class="container">
    
    <h2 style="text-align: center; margin-bottom: 30px; margin-top: 30px;">Create your invitation</h2>
    
    <form id="eventForm" action="" method="post">
        <div class="form-group mb-3">
            <label for="eventTitle">Event Title:</label>
            <input type="text" class="form-control" id="eventTitle" placeholder ="Input your event title" required>
        </div>
        <div class="form-row">
            <div class="form-group mb-3">
                <label for="startDate">Start Date:</label>
                <input type="date" class="form-control" id="startDate" required>
            </div>
            <div class="form-group mb-3">
                <label for="startTime">Start Time:</label>
                <input type="time" class="form-control" id="startTime" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group mb-3">
                <label for="endDate">End Date:</label>
                <input type="date" class="form-control" id="endDate" required>
            </div>
            <div class="form-group mb-3">
                <label for="endTime">End Time:</label>
                <input type="time" class="form-control" id="endTime" required>
            </div>
        </div>
        <div class="form-group mb-3">
            <label for="location">Location:</label>
            <input type="text" class="form-control" id="location" placeholder ="Provide the location of your event" required>
        </div>
        <div class="form-group mb-3">
            <label for="description">Description:</label>
            <textarea class="form-control" id="description" rows="3" placeholder ="Provide any additional details" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary mb-3">Create Invite</button>
    </form>
</div>

<!-- Display area for URL -->
<div id="UrlDisplay" class="m-4">
    <h4 style = "text-align: center;">Event URL:</h4>
    <div class="input-group">
        <span id="icslink" class="input-group-text"> </span> <!-- eventurl returned from app.js-->
        <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button" onclick="copyUrl()">Copy</button>
        </div>
    </div>
</div>
</div>



<script>

    document.getElementById('eventForm').addEventListener('submit', function (event) {
        event.preventDefault();

        // Get form values
        const eventTitle = document.getElementById('eventTitle').value;
        var startDate = document.getElementById('startDate').value;
        startDate = startDate.replace(/-/g,"");
        var startTime = document.getElementById('startTime').value;
        startTime = startTime.replace(/:/g,"");
        startTime = startTime+"00";
        var endDate = document.getElementById('endDate').value;
        endDate = endDate.replace(/-/g,"");
        var endTime = document.getElementById('endTime').value;
        endTime = endTime.replace(/:/g,"");
        endTime = endTime+"00";
        const location = document.getElementById('location').value;
        const description = document.getElementById('description').value;

        // Create iCalendar (ICS) content
        const icsContent = 
        `BEGIN:VCALENDAR
VERSION:2.0
PRODID:github.com/jenchong235
BEGIN:VEVENT
UID:event${eventTitle}
CLASS:PUBLIC
DESCRIPTION:${description}
DTSTART:${startDate}T${startTime}
DTEND:${endDate}T${endTime}
LOCATION:${location}
SUMMARY:${eventTitle}
END:VEVENT
END:VCALENDAR`;

        const response = fetch('/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ icsData: icsContent }),
        }).then((response) => {
    // Our handler throws an error if the request did not succeed.
    if (!response.ok) {
      throw new Error(`HTTP error: ${response.status}`);
    }
    // Otherwise (if the response succeeded), our handler fetches the response
    // as text by calling response.text(), and immediately returns the promise
    // returned by `response.text()`.
    return response.text();
  }).then((text) => {
    document.getElementById('icslink').innerHTML = text
  })

        // Create a blob and download the file
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = eventTitle+'.ics';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Show the display area for URL
        // document.getElementById('UrlDisplay').style.display = 'block';
        

    });

 
    // Function to copy URL

    function copyUrl() {
        
        var urlText = document.getElementById("icslink").textContent;
        var tempTextarea = document.createElement('textarea');
        tempTextarea.value = urlText;
        document.body.appendChild(tempTextarea);
        tempTextarea.select();
        tempTextarea.setSelectionRange(0, 99999); /* For mobile devices */

        document.execCommand('copy');
        document.body.removeChild(tempTextarea);
        alert('Event URL copied to clipboard!');
    }

</script>


</body>
</html>
